<html>
<body>
Speed Test <hr>



<script src="network.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script type='text/javascript'>
	var clientLocation;
	var serverLocation;
	var serverURLNode = 'http://'+window.location.host+'/speedtest/speedtestserver';

	function getHostName(url) {
		var match = url.match(/:\/\/(www[0-9]?\.)?(.[^/:]+)/i);
		if (match != null && match.length > 2 && typeof match[2] === 'string' && match[2].length > 0) {
			return match[2];
		}
		else {
			return '';
		}
	}

	function start(size, server) {
		//document.getElementById('result').innerHTML += 'download speed test with '+server+' : duration='+settings.delay/1000+' seconds <br>';
    }

    function progress(avg, instant, location) {
		console.log('progress '+location+' :'+instant/1024/1024);
    }

    function end(avg, server) {
    	avg = avg * 8 / 1024 / 1024;
		document.getElementById('result').innerHTML += server+' result: '+avg.toFixed(2)+' Mbits/sec, or '+(avg/8).toFixed(2)+'MBytes/sec <br>';
    }
	function restart(size,net) {
		console.log('restart:'+size);
	}
	function test(serverURL,location) {
		var settings = {endpoint:serverURL,delay:5000,data:{size:50*1024*1024}};
		var net = new Network(settings);
		net.download.on('start', function(size) {return start(size,location);});
		net.download.on('progress', function(avg, instant) {return progress(avg,instant,location);});
		net.download.on('restart', function(size) {return restart(size,net)});
		net.download.on('end', function(avg) {return end(avg,location);});
		net.download.start();
	}

	function testAll() {
		var serverList = 
		[
			{url:'http://172.104.83.248/speedtest/speedtestserver', location:'Japan'},
			{url:'http://52.78.137.116/speedtest/speedtestserver', location:'Korea'},
			{url:'http://139.162.37.171:8080/speedtest/speedtestserver', location:'Singapore'},
			{url:'http://137.116.169.130/speedtest/speedtestserver', location:'Hong Kong'}
		];

		serverList.forEach(function(server) {
			test(server.url, server.location);
		});
		
	}

	$.getJSON("http://freegeoip.net/json/", function (data) {
			var country = data.country_name;
			var ip = data.ip;
			document.getElementById('result').innerHTML += 'your ip: '+ip+', location:'+country+'<hrr>';
			clientLocation = country;
	});
	$.getJSON("http://freegeoip.net/json/"+window.location.hostname, function (data) {
			var country = data.country_name;
			var ip = data.ip;
			document.getElementById('result').innerHTML += 'server ip: '+ip+', location:'+country+'<hr>';
			serverLocation = country;
	});
</script>

<input type="button" onclick="test(serverURLNode,serverLocation);" name="ok" value="speed test (this server)"  /> <br>
<input type="button" onclick="testAll();" name="ok" value="speed test (all)"  /> <br>

<hr>

<div id=result></div>

</body>
</html>